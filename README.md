# Лабораторная работа 2 Tftp сервер

## Инструкция по использованию:
1. Зайти в папку `src`.
2. Скомпилировать программу: `javac tftp.java`.
3. Запустить программу: `java tftp`.
### Использование программы:
```
Usage: [-h] [--host HOST] [-p PORT]
                optional arguments:
                  -h,                   show this help message and exit
                  --host HOST           IP of the interface the server will listen on.
                                        Default: 127.0.0.1
                  -p PORT               Port the server will listen on. Default: 69. TFTP
                                        standard-compliant port: 69 - requires superuser
                                        privileges.
```
## Описание протокола
TFTP (англ. Trivial File Transfer Protocol — простой протокол передачи файлов) используется главным образом для первоначальной загрузки бездисковых рабочих станций. TFTP, в отличие от FTP, не содержит возможностей аутентификации и основан на транспортном протоколе UDP.

### Типы пакетов

Сначала в TFTP-пакете идет поле размером в 2 байта, определяющее тип пакета:
##### ReadRequest (RRQ) - запрос на чтение файла
| Тип пакета | Имя файла  | Конец строки | Режим передачи | Конец строки |
| --         | --         | --           | --             | --           |
| 0x01       | строка     | 0x00         | строка         | 0x00         |
##### WriteRequest (WRQ) - запрос на запись файла
| Тип пакета | Имя файла  | Конец строки | Режим передачи | Конец строки |
| --         | --         | --           | --             | --           |
| 0x02       | строка     | 0x00         | строка         | 0x00         |
##### Data (DATA) - данные
| Тип пакета | Номер блока  | Данные | 
| --         | --           | --     | 
| 0x03       | 2 байта      | строка |
##### Acknowledgment (ACK) - подтверждение пакета
| Тип пакета | Номер блока  | 
| --         | --           | 
| 0x04       | 2 байта      | 
##### Error (ERR) - ошибка
| Тип пакета | Код ошибки  | Сообщение ошибки | Конец строки |
| --         | --          | --               | --           |
| 0x05       | 2 байта     | строка           |  0x00        |
### Процесс передачи данных
После получения RRQ-пакета сервером, он сразу посылает в качестве подтверждения пакет с данными и с ID пакета, равным единице. В случае с WRQ-запросом — сервер должен прислать ACK-пакет c номером пакета 0.
Каждый пакет данных содержит номер блока (block number), который затем используется в пакете подтверждения. Каждый пакет данных содержит 512 байт данных, за исключением последнего пакета, который содержит от 0 до 511 байт данных. Когда клиент получает пакет данных, который содержит меньше, чем 512 байт, он считает, что получил последний пакет.
Так как TFTP использует ненадежный UDP, то именно от конкретной реализации TFTP зависит, как будут обработаны потерянные и дублированные пакеты. В случае потери пакета отправитель отрабатывает тайм-аут и осуществляет повторную передачу.
### Ошибки
| Код ошибки | Описание                                      |
| --         | --                                            |
| 0          | Нет определенного кода, см. текст ошибки      |
| 1          | Файл не найден                                |
| 2          | Доступ запрещен                               |
| 3          | Невозможно выделить место на диске            |
| 4          | Некорректная TFTP-операция                    |
| 5          | Неправильный Transfer ID                      |
| 6          | Файл уже существует                           |
| 7          | Пользователь не существует                    |
| 8          | Неправильная опция                            |
## Реализация 
TFTP сервер реализован на языке Java. Точка входа в программу - класс `tftp`. В нем обрабатываются аргументы командной строки и запускается бесконечный цикл который слушает `DatagramSocket` с заданным портом и адресом. Как только сокет получит первый пакет будет опредеделено с помощью метода `TftpPacket.receive(DatagramSocket socket)` какой это пакет (RRQ\WRQ). Дальше в зависимости от типа пакета будет создан класс `ReadRequest` или `WriteRequest` в которых происходит логика загрузки/отдачи файлов. Класс `SumHelper` является вспомогательным и служит для определения хэш-суммы файла. В фалйе `Tftpacket.java` лежат классы, которые являются представлениями различных пакетов которые передаются через tftp протокол (RRQ, WRQ, ACK и т.д.).
Папка `storage` является хранилищем данных сервера. Оттуда берутся файлы для отправки и туда сохраняются файлы от клиента. На данный момент там находятся несколько тестовых файлов.
Для тестирования работы использовался стандартный tftp-клиент для windows на машине, где запущен сервер и на другой машине, которая находилась в одной сети с сервером. Протестирована передача различных файлов различных размеров. Также протестирована передача файлов в 2 режимах передачи (netascii, octet).

