# Лабораторная работа 2 DHCP клиент

## Инструкция по использованию:
Программа написана на языке Java.
1. Скомпилировать программу: `javac dhcp_client.java`.
2. Запустить программу: `java dhcp_client`.

### Пример использования программы:
```
D:\Projects\Java\DHCP_new\DHCP_Client>java dhcp_client
Send Discover Packet
Received a response
Response is Offer
Ip: 192.168.1.2
Send Request
Received a response
Response is Pack
Ip: 192.168.1.2
```
## Описание протокола

DHCP - сетевой протокол, позволяющий сетевым устройствам автоматически получать IP-адрес и другие параметры, 
необходимые для работы в сети TCP/IP. Данный протокол работает по модели «клиент-сервер». Для автоматической 
конфигурации компьютер-клиент на этапе конфигурации сетевого устройства обращается к так называемому серверу
 DHCP и получает от него нужные параметры. Сетевой администратор может задать диапазон адресов, распределяемых 
 сервером среди компьютеров. Это позволяет избежать ручной настройки компьютеров сети и уменьшает количество
 ошибок. Протокол DHCP используется в большинстве сетей TCP/IP. Передача данных производится при помощи 
 протокола UDP. По умолчанию запросы от клиента делаются на 67 порт к серверу, сервер в свою очередь отвечает 
 на порт 68 к клиенту, выдавая адрес IP и другую необходимую информацию, такую, как сетевую маску,
 маршрутизатор и серверы DNS.
### Структура сообщений DHCP

| Поле	| Описание	| Длина (в байтах) |
| --	  | --      	| --               |
|op	   | Тип сообщения. Например может принимать значения: BOOTREQUEST (0x01, запрос от клиента к серверу) и BOOTREPLY (0x02, ответ от сервера к клиенту). |	1 |
| htype|	Тип аппаратного адреса. Допустимые значения этого поля определены в RFC 1700 «Assigned Numbers». Например, для MAC-адреса Ethernet это поле принимает значение 0x01. |1|
|hlen|	Длина аппаратного адреса в байтах. Для MAC-адреса Ethernet —0x06.|	1|
|hops|	Количество промежуточных маршрутизаторов (так называемых агентов ретрансляции DHCP), через которые прошло сообщение. Клиент устанавливает это поле в 0x00.|	1|
|xid|	Уникальный идентификатор транзакции в 4 байта, генерируемый клиентом в начале процесса получения адреса.|	4|
|secs|	Время в секундах с момента начала процесса получения адреса. Может не использоваться (в этом случае оно устанавливается в 0x0000).|	2|
|flags|	Поле для флагов — специальных параметров протокола DHCP.|	2|
|ciaddr|	IP-адрес клиента. Заполняется только в том случае, если клиент уже имеет собственный IP-адрес и способен отвечать на запросы ARP (это возможно, если клиент выполняет процедуру обновления адреса по истечении срока аренды).	|4|
|yiaddr|	Новый IP-адрес клиента, предложенный сервером.	|4|
|siaddr|	IP-адрес сервера. Возвращается в предложении DHCP (см. ниже).	|4|
|giaddr|	IP-адрес агента ретрансляции, если таковой участвовал в процессе доставки сообщения DHCP до сервера.|	4|
|chaddr|	Аппаратный адрес (обычно MAC-адрес) клиента.	|16|
|sname|	Необязательное имя сервера в виде нуль-терминированной строки.	|64|
|file|	Необязательное имя файла на сервере, используемое бездисковыми рабочими станциями при удалённой загрузке. Как и sname, представлено в виде нуль-терминированной строки.	|128|
|options|	Поле опций DHCP. Здесь указываются различные дополнительные параметры конфигурации. В начале этого поля указываются четыре особых байта со значениями 99, 130, 83, 99 («волшебные числа»), позволяющие серверу определить наличие этого поля. Поле имеет переменную длину, однако DHCP-клиент должен быть готов принять DHCP-сообщение длиной в 576 байт (в этом сообщении поле options имеет длину 340 байт).	|переменная|
### Общий принцип работы DHCP
* Клиент рассылает широковещательный UDP запрос (DHCPDISCOVER) по всей сети с запросом 
получить IP-адрес. По умолчанию запросы от клиента делаются на 67 порт к серверу, сервер в свою очередь отвечает 
              на порт 68 к клиенту.Внутри пакета DHCPDISCOVER
               включен MAC адрес устройства клиента.
* Получив сообщение от клиента, сервер определяет требуемую конфигурацию клиента в соответствии с указанными сетевым администратором настройками. Сервер отправляет ему ответ (DHCPOFFER), в котором предлагает конфигурацию. Предлагаемый клиенту IP-адрес указывается в поле yiaddr. Прочие параметры (такие, как адреса маршрутизаторов и DNS-серверов) указываются в виде опций в соответствующем поле. Это сообщение DHCP-сервер отправляет хосту, пославшему DHCPDISCOVER, на его MAC, при определенных обстоятельствах сообщение может распространяться как широковещательная рассылка. 
* Выбрав одну из конфигураций, предложенных DHCP-серверами, клиент отправляет запрос DHCP (DHCPREQUEST). Он рассылается широковещательно; при этом к опциям, указанным клиентом в сообщении DHCPDISCOVER, добавляется специальная опция — идентификатор сервера — указывающая адрес DHCP-сервера.
* Сервер, получивший DHCPREQUEST, отправляет пакет формата DHCPACK, в котором в очередной раз перечисляет сетевые настройки, предназначенные для данного клиента.

## Реализация 
Программа реалиазована на языке Java. Используются `DatagramSocket` - сокеты для отправки и получения `DatagramPacket`, 
в которых хранятся данные с запросами. `DHCP_Message.java` представляет собой стандартное сообщение DHCP со всеми полями,
которые используются в DHCP протоколе. Также с помощью этого класса можно создать нужное сообщение (DISCOVER, REQUEST),
для отправки в сокет. В классе `DhcpMessageHelper` есть вспомогательный статический метод для определения сообщения от сервера
(OFFER, PACK). Вся работа клиента происходит в `DhcpRunner.java`. Сначало посылается широковещательное сообщение 
DISCOVER, затем слушется сокет, на ответ от сервера. Когда приходит ответ от сервера, определяется, что это за ответ: 
если это OFFER, то серверу отправляется REQUEST на подтверждение выданного ip адреса. Если это подтверждение 
ip адреса (PACK) то выданный ip адрес "принимается" и программа завершает свою работу.
### Тестирование 
Тестирование проводилось на локальной машине с использованием стандартных реализаций DHCP сервера и реализации DHCP сервера на Java.
